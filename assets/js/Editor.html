<script>
	import Codemirror from "./codemirror/Codemirror.html"
	import Chart from "./Chart.html"
	import { chartData } from "./chartConfig.js"
    import Table from "./Table.html"

	export let authenticated, user_email

	let text, result, data, error, chart_data
	let loading = false
    let chart_key = 0
    let table_key = 0
  	let chart;

	function run_query(){
		loading = true
		fetch('/api/run', {
            method: 'POST',
            headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json',
				'x-csrf-token': window.csrfToken
			},
            body: JSON.stringify({ text })
        })
        .then(resp => resp.json())
        .then(s => {
			if ("error" in s){
				error = s.error
			} else {
				error = undefined
				data = s
				chart_data = chartData(s)
                table_key++
				chart_key++
			}
		})
		.then( _ => loading = false)
	}

	function on_change(cm){
		text = cm.getValue()
	}
</script>

<style>
.container {
	display: flex;
}

.table-container {
	max-width: 50vw;
	overflow-y: scroll;
	overflow-x: scroll;
}

.table-sm {
	max-height: 43vh;
}

.table-lg {
	max-height: 85vh;
}

.left-half {
	background-color:var(--main-bg-color);
	flex-grow: 1;
}

.half {
	height: 100vh;
	padding: 20px;
	flex-grow: 1;
}

.top-bar {
	height: 36px;
	display: inherit;
	align-items: center;
    direction: rtl;
	flex: 0 0 auto;
	margin-bottom: 1em;
}
</style>

<div class="container">
	<div class="half left-half">
		<div class="top-bar">
			<a class="btn btn-2" on:click={run_query}>Format</a>
            <a class="btn btn-3" on:click={run_query}>Execute</a>
            <a class="btn btn-1" on:click={run_query}>Save</a>
		</div>
		<Codemirror mode="python" on_change={on_change} submit_f={run_query}></Codemirror>
	</div>
	<div class="half">
		<div class="top-bar">
			<a class="btn btn-4">?</a>
			<a class="btn btn-4">Explore</a>
			<a class="btn btn-4" href="/account">Account</a>
		</div>
		{#if error}
			<div class="alert alert-danger">
				{error}
			</div>
		{/if}
		{#if chart_data}
			{#each [chart_key] as k (k)}
				<div class="chart-container">
					<Chart bind:this={chart} data={chart_data} width="80%" height="40%"/>
				</div>
			{/each}
		{/if}
		{#if data}
            {#each [table_key] as k (k)}
                <div class="table-container {chart_data ? 'table-sm' : 'table-lg'}">
                    <Table data={data} />
                </div>
            {/each}
		{/if}
	</div>
</div>
